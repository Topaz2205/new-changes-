{% extends "base.html" %}

{% block title %}עריכת הזמנה{% endblock %}

{% block content %}
<div class="container" dir="rtl">
  <h1>עריכת הזמנה #{{ order.order_id }}</h1>

  <form method="POST" action="{{ url_for('orders.edit_order', order_id=order.order_id) }}">
    <!-- סטטוס (UPPER) -->
    <label for="status">סטטוס הזמנה:</label><br>
    {% set s = (order.status or '')|upper %}
    <select id="status" name="status" required>
      <option value="NEW"       {{ 'selected' if s == 'NEW' else '' }}>NEW</option>
      <option value="PAID"      {{ 'selected' if s == 'PAID' else '' }}>PAID</option>
      <option value="SHIPPED"   {{ 'selected' if s == 'SHIPPED' else '' }}>SHIPPED</option>
      <option value="DELIVERED" {{ 'selected' if s == 'DELIVERED' else '' }}>DELIVERED</option>
      <option value="CANCELLED" {{ 'selected' if s == 'CANCELLED' else '' }}>CANCELLED</option>
    </select><br><br>

    <label for="employee_id">מזהה עובד:</label><br>
    <input type="number" id="employee_id" name="employee_id" value="{{ order.employee_id or '' }}"><br><br>

    <label for="freight">עלות משלוח:</label><br>
    <input type="number" step="0.01" id="freight" name="freight" value="{{ order.freight or '' }}"><br><br>

    <label for="total_amount">סכום כולל:</label><br>
    <input type="number" step="0.01" id="total_amount" name="total_amount" value="{{ order.total_amount or '' }}"><br><br>

    {# פונקציה קטנה לעיבוד datetime לערך של input type="datetime-local" #}
    {% macro dtval(dt) -%}
      {%- if dt %}
        {%- if dt.__class__.__name__ == 'datetime' -%}
          {{ dt.strftime('%Y-%m-%dT%H:%M') }}
        {%- else -%}
          {{ dt[:16] if 'T' in dt else dt }}
        {%- endif -%}
      {%- endif -%}
    {%- endmacro %}

    <label for="shipped_date">תאריך יציאה למשלוח:</label><br>
    <input type="datetime-local" id="shipped_date" name="shipped_date" value="{{ dtval(order.shipped_date) }}"><br><br>

    <label for="expected_delivery">תאריך משלוח צפוי:</label><br>
    <input type="datetime-local" id="expected_delivery" name="expected_delivery" value="{{ dtval(order.expected_delivery) }}"><br><br>

    <label for="actual_delivery">תאריך משלוח בפועל:</label><br>
    <input type="datetime-local" id="actual_delivery" name="actual_delivery" value="{{ dtval(order.actual_delivery) }}"><br><br>

    <button type="submit" class="btn">שמור שינויים</button>
  </form>

  <hr>

  <!-- טופס אופציונלי לעדכון מהיר של סטטוס + סיבת עיכוב -->
  <h3>עדכון סטטוס מהיר</h3>
  <form method="POST" action="{{ url_for('orders.set_status', order_id=order.order_id) }}">
    <label for="quick_status">סטטוס חדש:</label>
    <select id="quick_status" name="status" required>
      <option value="NEW">NEW</option>
      <option value="PAID">PAID</option>
      <option value="SHIPPED">SHIPPED</option>
      <option value="DELIVERED">DELIVERED</option>
      <option value="CANCELLED">CANCELLED</option>
    </select>

    <label for="delay_reason">סיבת עיכוב (לא חובה):</label>
    <input type="text" id="delay_reason" name="delay_reason" placeholder="למשל: לקוח ביקש דחייה">

    <button type="submit" class="btn">עדכן סטטוס</button>
  </form>
</div>
{% endblock %}
